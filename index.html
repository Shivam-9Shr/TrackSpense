<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transaction Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    .transaction-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    .custom-scrollbar::-webkit-scrollbar { width: 6px; }
    .custom-scrollbar::-webkit-scrollbar-track { background: #1f2937; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background: #4b5563; border-radius:3px; }
    .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #6b7280; }
    .person-item:hover { background-color: #374151; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loader { border: 2px solid rgba(255,255,255,0.3); border-top-color: #FBBF24; border-radius:50%; width:1.5rem; height:1.5rem; animation: spin 1s linear infinite; }
    .spotlight { position: fixed; width:400px; height:400px; border-radius:50%; pointer-events:none; background: radial-gradient(circle, rgba(251,191,36,0.08) 0%, rgba(251,191,36,0.05) 15%, transparent 50%); transform: translate(-50%,-50%); mix-blend-mode: screen; z-index:50; opacity:0; will-change: transform, opacity; }
    .glow-card { position:relative; overflow:hidden; --glow-x:50%; --glow-y:50%; --glow-intensity:0; --glow-radius:400px; }
    .glow-card::after {
      content:''; position:absolute; inset:0; padding:2px;
      background: radial-gradient(var(--glow-radius) circle at var(--glow-x) var(--glow-y), rgba(251,191,36,calc(var(--glow-intensity) * 0.4)) 0%, rgba(251,191,36,calc(var(--glow-intensity) * 0.2)) 30%, transparent 60%);
      border-radius: inherit; pointer-events:none; transition: opacity .3s ease; z-index:1;
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 flex items-center justify-center min-h-screen p-4">

  <!-- Global Loader -->
  <div id="global-loader" class="fixed inset-0 bg-gray-900 flex flex-col items-center justify-center z-[100]">
    <div class="loader" style="width:2.5rem;height:2.5rem;border-width:3px;"></div>
    <p class="text-gray-400 mt-4">Loading Application...</p>
  </div>

  <!-- Auth View -->
  <div id="auth-view" class="w-full max-w-md mx-auto hidden">
    <div class="bg-gray-800 rounded-2xl shadow-xl p-8 border border-gray-700">
      <h1 class="text-3xl font-bold text-center text-white mb-2">Welcome!</h1>
      <p class="text-gray-400 text-center mb-8">Sign in with your Google account to securely access your transaction tracker.</p>
      <button id="google-signin-btn" class="w-full flex items-center justify-center gap-3 bg-gray-700 font-medium py-3 rounded-xl hover:bg-gray-600 transition-colors">
        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z"/><path fill="#FF3D00" d="m6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z"/><path fill="#4CAF50" d="m24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238A11.91 11.91 0 0 1 24 36c-5.222 0-9.618-3.234-11.303-7.618l-6.571 4.819A20 20 0 0 0 24 44z"/><path fill="#1976D2" d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C44.434 36.316 48 30.732 48 24c0-1.341-.138-2.65-.389-3.917z"/></svg>
        <span id="google-signin-text">Sign in with Google</span>
        <div id="google-signin-loader" class="loader hidden" style="width:1.25rem;height:1.25rem;border-width:2px;"></div>
      </button>
      <p id="auth-error" class="text-red-500 text-center text-sm mt-4"></p>
    </div>
  </div>

  <!-- App View -->
  <div id="app-view" class="hidden w-full max-w-3xl mx-auto bg-gray-800 rounded-2xl shadow-xl p-6 md:p-8 border border-gray-700 relative">
    <!-- Profile -->
    <div class="absolute top-4 right-4">
      <div id="profile-button" class="flex items-center space-x-2 cursor-pointer p-1.5 rounded-full bg-gray-700/50 hover:bg-gray-700 transition-colors">
        <img id="profile-avatar" src="" class="w-8 h-8 rounded-full object-cover bg-gray-600">
        <span id="profile-name" class="hidden md:block text-sm font-medium text-gray-200 pr-2"></span>
      </div>
      <div id="profile-dropdown" class="absolute right-0 mt-2 w-48 bg-gray-700 rounded-xl shadow-lg z-50 hidden py-1">
        <button id="sign-out-btn" class="w-full text-left px-4 py-2 text-sm text-gray-200 hover:bg-gray-600 flex items-center gap-3 rounded-xl">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M10 12.5a.5.5 0 0 1-.5.5h-8a.5.5 0 0 1-.5-.5v-9a.5.5 0 0 1 .5-.5h8a.5.5 0 0 1 .5.5v2a.5.5 0 0 0 1 0v-2A1.5 1.5 0 0 0 9.5 2h-8A1.5 1.5 0 0 0 0 3.5v9A1.5 1.5 0 0 0 1.5 14h8a1.5 1.5 0 0 0 1.5-1.5v-2a.5.5 0 0 0-1 0z"/><path fill-rule="evenodd" d="M15.854 8.354a.5.5 0 0 0 0-.708l-3-3a.5.5 0 0 0-.708.708L14.293 7.5H5.5a.5.5 0 0 0 0 1h8.793l-2.147 2.146a.5.5 0 0 0 .708.708z"/></svg>
          Sign Out
        </button>
      </div>
    </div>

    <header class="text-center mb-8">
      <h1 class="text-3xl md:text-4xl font-bold text-white">Transaction Tracker</h1>
      <p class="text-gray-400 mt-2">Log your expenses and receivables with ease.</p>
    </header>

    <!-- Mode Switcher -->
    <section class="mb-8 flex justify-center">
      <div class="bg-gray-700 p-1 rounded-xl flex space-x-1">
        <button id="personal-mode-btn" class="px-6 py-2 rounded-xl text-sm font-medium transition-colors bg-yellow-500 text-black">Personal</button>
        <button id="business-mode-btn" class="px-6 py-2 rounded-xl text-sm font-medium transition-colors text-gray-300 hover:bg-gray-600">Business</button>
      </div>
    </section>

    <!-- Summary -->
    <section id="summary-section" class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-8">
      <div id="daily-total-card" class="bg-gray-700 p-6 rounded-xl text-center glow-card">
        <h2 id="daily-total-label" class="text-base font-medium text-yellow-400">Today's Spending</h2>
        <p id="daily-total" class="text-3xl font-bold text-yellow-300 mt-2">₹0.00</p>
      </div>
      <div class="bg-gray-700 p-6 rounded-xl text-center glow-card">
        <h2 id="monthly-total-label" class="text-base font-medium text-yellow-400">This Month's Spending</h2>
        <p id="monthly-total" class="text-3xl font-bold text-yellow-300 mt-2">₹0.00</p>
      </div>
      <div class="bg-gray-700 p-6 rounded-xl text-center glow-card">
        <h2 id="receivable-total-label" class="text-base font-medium text-yellow-400">Pending to Collect</h2>
        <p id="receivable-total" class="text-3xl font-bold text-yellow-300 mt-2">₹0.00</p>
      </div>
    </section>

    <!-- Input Form -->
    <section class="mb-8">
      <form id="transaction-form" class="space-y-4">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div id="description-field-wrapper" class="md:col-span-1">
            <label for="description" class="block text-sm font-medium text-gray-400 mb-1">Description</label>
            <input type="text" id="description" placeholder="e.g., Lunch, Movie tickets" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition">
          </div>
          <div>
            <label for="person-selector" class="block text-sm font-medium text-gray-400 mb-1">Person</label>
            <div id="person-selector" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-xl flex items-center justify-between cursor-pointer hover:bg-gray-600 transition-all">
              <div class="flex items-center">
                <div id="selected-person-avatar-container" class="w-8 h-8 rounded-full bg-gray-600 flex items-center justify-center mr-3 overflow-hidden">
                  <svg id="selected-person-avatar-placeholder" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-400"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                  <img id="selected-person-avatar" src="" class="hidden w-full h-full object-cover">
                </div>
                <span id="selected-person-name" class="text-gray-400">Select a person</span>
              </div>
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9l6 6 6-6"/></svg>
            </div>
            <input type="hidden" id="person">
          </div>

          <div>
            <label for="amount" class="block text-sm font-medium text-gray-400 mb-1">Amount (₹)</label>
            <input type="number" id="amount" placeholder="150" min="0.01" step="0.01" required class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition">
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
          <div id="type-field-wrapper" class="md:col-span-3">
            <label for="type" class="block text-sm font-medium text-gray-400 mb-1">Transaction Type</label>
            <select id="type" class="w-full px-4 py-3 bg-gray-700 border border-gray-600 text-white rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 transition">
              <option value="expense" selected>Expense (I paid)</option>
              <option value="receivable">Receivable (To collect)</option>
            </select>
          </div>
          <button id="submit-btn" type="submit" class="w-full bg-yellow-500 text-black font-semibold py-3 px-4 rounded-xl hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500 transition duration-300 shadow-sm md:col-start-4">
            Add Transaction
          </button>
        </div>

        <div id="recurring-fields-wrapper" class="hidden space-y-2 md:flex md:space-y-0 md:space-x-4 md:items-end pt-2">
          <div class="flex-grow">
            <label for="frequency" class="block text-sm font-medium text-gray-400 mb-1">Frequency</label>
            <select id="frequency" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-xl">
              <option value="daily">Daily</option>
              <option value="weekly">Weekly</option>
              <option value="monthly" selected>Monthly</option>
            </select>
          </div>
          <div>
            <label for="start-date" class="block text-sm font-medium text-gray-400 mb-1">Start Date</label>
            <input type="date" id="start-date" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-xl">
          </div>
        </div>

        <div id="recurring-options-wrapper" class="pt-2 flex justify-between items-center">
          <label class="flex items-center space-x-2 cursor-pointer text-sm text-gray-400">
            <input type="checkbox" id="is-recurring-checkbox" class="form-checkbox h-4 w-4 bg-gray-700 border-gray-600 rounded text-yellow-500 focus:ring-yellow-500">
            <span>Make this a recurring transaction</span>
          </label>
          <button type="button" id="manage-recurring-btn" class="text-sm text-yellow-400 hover:underline">Manage Recurring</button>
        </div>
      </form>
    </section>

    <!-- Search & Export -->
    <section class="my-6 space-y-4">
      <div class="relative w-full">
        <input type="text" id="search-input" placeholder="Search transactions..." class="w-full pl-10 pr-4 py-2 bg-gray-700 border border-gray-600 text-white rounded-xl focus:ring-2 focus:ring-yellow-500">
        <svg class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
        <div id="client-filter-wrapper" class="w-full hidden">
          <label for="client-filter-select" class="text-sm font-medium text-gray-400">Filter by Client</label>
          <select id="client-filter-select" class="w-full mt-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-xl">
            <option value="">All Clients</option>
          </select>
        </div>
        <div id="start-date-filter-wrapper" class="w-full">
          <label for="filter-start-date" class="text-sm font-medium text-gray-400">From</label>
          <input type="date" id="filter-start-date" class="w-full mt-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-xl">
        </div>
        <div id="end-date-filter-wrapper" class="w-full">
          <label for="filter-end-date" class="text-sm font-medium text-gray-400">To</label>
          <input type="date" id="filter-end-date" class="w-full mt-1 px-4 py-2 bg-gray-700 border border-gray-600 rounded-xl">
        </div>
        <button id="export-csv-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-gray-600 text-white font-semibold rounded-xl hover:bg-gray-500 transition">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          Export CSV
        </button>
      </div>
    </section>

    <!-- Transaction lists -->
    <div id="personal-view">
      <section id="budget-section" class="mb-6 bg-gray-700/50 p-4 rounded-xl">
        <div class="flex justify-between items-center mb-2">
          <h3 class="font-semibold text-gray-300">Monthly Budget</h3>
          <div class="flex items-center gap-4">
            <button id="get-summary-btn" class="text-sm font-semibold text-black bg-yellow-500 hover:bg-yellow-600 px-3 py-1 rounded-lg transition">✨ Get Smart Summary</button>
            <button id="set-budget-btn" class="text-sm text-yellow-400 hover:underline">Set Budget</button>
          </div>
        </div>
        <div class="w-full bg-gray-600 rounded-full h-3">
          <div id="budget-progress" class="bg-green-500 h-3 rounded-full transition-all duration-500" style="width:0%"></div>
        </div>
        <p id="budget-summary" class="text-right text-sm mt-1.5 text-gray-400">₹0.00 / ₹0.00</p>
      </section>

      <h2 class="text-xl font-semibold mb-4 border-b pb-2 border-gray-700">Transaction History</h2>
      <div id="transaction-list" class="space-y-3 max-h-96 overflow-y-auto pr-2 custom-scrollbar"></div>
    </div>

    <div id="business-view" class="hidden space-y-8">
      <div>
        <h2 class="text-xl font-semibold mb-4 border-b pb-2 border-gray-700">Upcoming Payments</h2>
        <div id="upcoming-list" class="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div>
      </div>
      <div>
        <h2 class="text-xl font-semibold mb-4 border-b pb-2 border-gray-700">Collected Payments</h2>
        <div id="collected-list" class="space-y-3 max-h-60 overflow-y-auto pr-2 custom-scrollbar"></div>
      </div>
    </div>

    <p id="loading-state" class="text-gray-500 text-center py-4">Loading transactions...</p>

    <!-- Charts -->
    <section id="charts-section" class="my-8">
      <h2 class="text-xl font-semibold mb-4 border-b pb-2 border-gray-700">Visualizations</h2>
      <div id="personal-chart-container" class="bg-gray-700/50 p-4 rounded-xl">
        <canvas id="spending-chart"></canvas>
      </div>
      <div id="business-chart-container" class="hidden bg-gray-700/50 p-4 rounded-xl">
        <canvas id="earnings-chart"></canvas>
      </div>
    </section>
  </div>

  <!-- People modal -->
  <div id="people-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm p-6 border border-gray-700">
      <div class="flex justify-between items-center mb-4">
        <h3 id="modal-title" class="text-xl font-bold text-white">Select or Add Person</h3>
        <button id="close-people-modal-btn" class="text-gray-500 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      <form id="add-person-form" class="space-y-3 mb-4">
        <input type="text" id="new-person-name" placeholder="Add new person's name" required class="flex-grow w-full px-3 py-3 bg-gray-700 border border-gray-600 text-white placeholder-gray-400 rounded-xl focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500">
        <button type="submit" id="add-person-btn" class="w-full bg-yellow-500 text-black font-semibold py-2 px-4 rounded-xl hover:bg-yellow-600">Add Person</button>
      </form>
      <div id="people-list-modal" class="max-h-60 overflow-y-auto space-y-1 custom-scrollbar pr-2"></div>
    </div>
  </div>

  <!-- Budget modal -->
  <div id="budget-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-xs p-6 border border-gray-700">
      <h3 class="text-xl font-bold text-white mb-4">Set Monthly Budget</h3>
      <form id="budget-form">
        <label for="budget-amount" class="block text-sm font-medium text-gray-400 mb-1">Budget Amount (₹)</label>
        <input type="number" id="budget-amount" placeholder="5000" min="0" step="100" class="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-xl mb-4">
        <div class="flex gap-2">
          <button type="button" id="cancel-budget-btn" class="w-full bg-gray-600 py-2 rounded-xl">Cancel</button>
          <button type="submit" class="w-full bg-yellow-500 text-black font-semibold py-2 rounded-xl">Save</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Recurring modal -->
  <div id="recurring-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg p-6 border border-gray-700">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-white">Manage Recurring Transactions</h3>
        <button id="close-recurring-modal-btn" class="text-gray-500 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      <div id="recurring-list-modal" class="max-h-80 overflow-y-auto space-y-2 custom-scrollbar pr-2"></div>
    </div>
  </div>

  <!-- Gemini modal (kept minimal) -->
  <div id="gemini-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-lg p-6 border border-gray-700">
      <div class="flex justify-between items-center mb-4">
        <h3 id="gemini-modal-title" class="text-xl font-bold text-white">✨ AI Assistant</h3>
        <button id="close-gemini-modal-btn" class="text-gray-500 hover:text-white text-3xl leading-none">&times;</button>
      </div>
      <div id="gemini-modal-content" class="max-h-80 overflow-y-auto space-y-2 custom-scrollbar pr-2 text-gray-300">
        <div class="flex justify-center items-center h-32"><div class="loader"></div></div>
      </div>
      <div id="gemini-modal-actions" class="mt-4 hidden">
        <button id="copy-gemini-content-btn" class="w-full bg-yellow-500 text-black font-semibold py-2 px-4 rounded-xl hover:bg-yellow-600">Copy to Clipboard</button>
      </div>
    </div>
  </div>

  <!-- Confirm modal -->
  <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-gray-800 rounded-2xl shadow-xl w-full max-w-sm p-6 border border-gray-700">
      <h3 id="confirm-modal-title" class="text-lg font-bold text-white mb-4">Confirm Action</h3>
      <p id="confirm-modal-body" class="text-gray-300 mb-6">Are you sure you want to proceed?</p>
      <div class="flex gap-4">
        <button id="confirm-modal-cancel-btn" class="w-full bg-gray-600 py-2 rounded-xl hover:bg-gray-500 transition">Cancel</button>
        <button id="confirm-modal-confirm-btn" class="w-full bg-red-600 text-white font-semibold py-2 rounded-xl hover:bg-red-700 transition">Confirm</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
      getAuth,
      onAuthStateChanged,
      GoogleAuthProvider,
      signInWithRedirect,
      getRedirectResult,
      signOut,
      setPersistence,
      browserLocalPersistence,
      signInWithPopup
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    import {
      getFirestore,
      collection,
      addDoc,
      serverTimestamp,
      onSnapshot,
      query,
      doc,
      deleteDoc,
      updateDoc,
      deleteField,
      setDoc,
      getDocs
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // ---------- Firebase config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBQE9DZBL3ugPDWBVKj8piCVT7q-X9p0to",
      authDomain: "expense-manager-2158b.firebaseapp.com",
      projectId: "expense-manager-2158b",
      storageBucket: "expense-manager-2158b.firebasestorage.app",
      messagingSenderId: "596327333035",
      appId: "1:596327333035:web:e2ec1998729a81e7258bee",
      measurementId: "G-QXTERJV3V8"
    };

    // Use projectId for appId in Firestore paths if needed
    const appId = firebaseConfig.projectId || firebaseConfig.appId || "expense-manager-2158b";

    // ---------- App state ----------
    let db, auth, userId = null;
    let peopleMap = {};
    let spendingChart = null;
    let earningsChart = null;
    let currentMode = 'personal';
    let allTransactions = [];
    let unsubscribeTransactions = () => {};
    let unsubscribePeople = () => {};
    let unsubscribeSettings = () => {};
    let unsubscribeRecurring = () => {};

    // ---------- DOM refs ----------
    const globalLoader = document.getElementById('global-loader');
    const authView = document.getElementById('auth-view');
    const appView = document.getElementById('app-view');
    const googleSigninBtn = document.getElementById('google-signin-btn');
    const googleSigninText = document.getElementById('google-signin-text');
    const googleSigninLoader = document.getElementById('google-signin-loader');
    const authErrorEl = document.getElementById('auth-error');
    const signOutBtn = document.getElementById('sign-out-btn');
    const loadingState = document.getElementById('loading-state');

    // many other DOM nodes are referenced later; they exist above

    // ---------- Initialize Firebase ----------
    try {
      const app = initializeApp(firebaseConfig);
      db = getFirestore(app);
      auth = getAuth(app);
    } catch (e) {
      console.error("Firebase init failed:", e);
      if (authErrorEl) authErrorEl.textContent = "Firebase configuration invalid. Check firebaseConfig.";
      if (globalLoader) globalLoader.classList.add('hidden');
      if (authView) authView.classList.remove('hidden');
    }

    // Set local persistence so redirect sign-in persists
    try {
      setPersistence(auth, browserLocalPersistence).catch(err => {
        console.warn("setPersistence error:", err);
      });
    } catch (e) {
      console.warn("setPersistence not available:", e);
    }

    // ---------- Auth state handling ----------
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        userId = user.uid;
        const profileNameEl = document.getElementById('profile-name');
        const profileAvatar = document.getElementById('profile-avatar');
        if (profileNameEl) profileNameEl.textContent = user.displayName || 'User';
        if (profileAvatar) profileAvatar.src = user.photoURL || `https://placehold.co/32x32/4A5568/E2E8F0?text=${getInitials(user.displayName || 'User')}`;

        if (authView) authView.classList.add('hidden');
        if (appView) appView.classList.remove('hidden');
        document.body.classList.remove('items-center');

        await checkAndProcessRecurringTransactions();
        switchMode(currentMode);
        initSpotlightEffect();
      } else {
        userId = null;
        if (authView) authView.classList.remove('hidden');
        if (appView) appView.classList.add('hidden');
        document.body.classList.add('items-center');
        unsubscribeAll();
      }
      if (globalLoader) globalLoader.classList.add('hidden');
    });

    // handle redirect result if present
    getRedirectResult(auth).then(result => {
      if (result && result.user) {
        console.log("Redirect sign-in success:", result.user);
      }
    }).catch(err => {
      console.error("getRedirectResult error:", err);
      if (authErrorEl) authErrorEl.textContent = `Error: ${err.code || err.message}`;
      if (globalLoader) globalLoader.classList.add('hidden');
      if (authView) authView.classList.remove('hidden');
    });

    // ---------- Sign-in button ----------
    googleSigninBtn?.addEventListener('click', async () => {
      if (authErrorEl) authErrorEl.textContent = '';
      googleSigninText?.classList.add('hidden');
      googleSigninLoader?.classList.remove('hidden');
      googleSigninBtn.disabled = true;
      const provider = new GoogleAuthProvider();

      try {
        await signInWithRedirect(auth, provider);
      } catch (err) {
        console.warn("signInWithRedirect failed, trying popup fallback:", err);
        try {
          await signInWithPopup(auth, provider);
        } catch (popupErr) {
          console.error("Popup sign-in failed:", popupErr);
          if (authErrorEl) authErrorEl.textContent = `Sign-in failed: ${popupErr.code || popupErr.message}`;
          googleSigninText?.classList.remove('hidden');
          googleSigninLoader?.classList.add('hidden');
          googleSigninBtn.disabled = false;
        }
      }
    });

    // sign-out
    signOutBtn?.addEventListener('click', async () => {
      try { await signOut(auth); } catch (e) { console.error("signOut error", e); }
    });

    // ---------- Helpers ----------
    function getInitials(name) {
      if (!name) return '??';
      const parts = name.split(' ').filter(Boolean);
      if (parts.length === 0) return '??';
      if (parts.length === 1) return parts[0][0].toUpperCase();
      return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
    }

    function unsubscribeAll() {
      try { unsubscribeTransactions(); } catch {}
      try { unsubscribePeople(); } catch {}
      try { unsubscribeSettings(); } catch {}
      try { unsubscribeRecurring(); } catch {}
    }

    // ---------- Mode switching ----------
    const personalModeBtn = document.getElementById('personal-mode-btn');
    const businessModeBtn = document.getElementById('business-mode-btn');
    personalModeBtn?.addEventListener('click', () => switchMode('personal'));
    businessModeBtn?.addEventListener('click', () => switchMode('business'));

    function switchMode(newMode) {
      currentMode = newMode;
      personalModeBtn?.classList.toggle('bg-yellow-500', newMode === 'personal');
      personalModeBtn?.classList.toggle('text-black', newMode === 'personal');
      businessModeBtn?.classList.toggle('bg-yellow-500', newMode === 'business');
      businessModeBtn?.classList.toggle('text-black', newMode === 'business');

      // unsubscribe and re-listen
      unsubscribeAll();
      clearAllLists();
      listenForData();
      resetForm();
    }

    function clearAllLists() {
      document.getElementById('transaction-list')?.innerHTML = '';
      document.getElementById('upcoming-list')?.innerHTML = '';
      document.getElementById('collected-list')?.innerHTML = '';
      document.getElementById('people-list-modal')?.innerHTML = '';
      document.getElementById('recurring-list-modal')?.innerHTML = '';
      if (loadingState) loadingState.style.display = 'block';
    }

    // ---------- Listeners ----------
    function listenForData() {
      if (!userId) return;
      listenForTransactions();
      listenForPeople();
      if (currentMode === 'personal') {
        listenForRecurring();
        listenForSettings();
      }
    }

    function listenForTransactions() {
      try {
        const colRef = collection(db, `artifacts/${appId}/users/${userId}/${currentMode}_transactions`);
        unsubscribeTransactions = onSnapshot(query(colRef), (snapshot) => {
          if (loadingState) loadingState.style.display = 'none';
          allTransactions = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
          applyFiltersAndRender();
        }, (err) => console.error("transactions onSnapshot error:", err));
      } catch (e) { console.error("listenForTransactions error:", e); }
    }

    function listenForPeople() {
      try {
        const colRef = collection(db, `artifacts/${appId}/users/${userId}/${currentMode}_people`);
        unsubscribePeople = onSnapshot(query(colRef), (snapshot) => {
          const peopleListModal = document.getElementById('people-list-modal');
          const clientFilterSelect = document.getElementById('client-filter-select');
          if (peopleListModal) peopleListModal.innerHTML = '';
          if (clientFilterSelect) clientFilterSelect.innerHTML = '<option value="">All Clients</option>';
          const newPeople = {};
          if (snapshot.empty) {
            if (peopleListModal) peopleListModal.innerHTML = `<p class="text-center text-gray-400">No ${currentMode === 'business' ? 'clients' : 'people'} added yet.</p>`;
          } else {
            snapshot.forEach(docSnap => {
              const person = docSnap.data();
              newPeople[person.name] = person.photoURL || null;
              const initials = getInitials(person.name);
              const photoSrc = `https://placehold.co/40x40/4A5568/E2E8F0?text=${initials}`;
              const personEl = document.createElement('div');
              personEl.className = 'person-item p-2 rounded-xl flex items-center justify-between';
              personEl.innerHTML = `<div class="flex items-center cursor-pointer flex-grow person-select-trigger" data-name="${person.name}" data-photo="${photoSrc}"><img src="${photoSrc}" class="w-10 h-10 rounded-full object-cover mr-3"><span class="font-medium">${person.name}</span></div>`;
              peopleListModal?.appendChild(personEl);
              if (currentMode === 'business' && clientFilterSelect) {
                const option = document.createElement('option');
                option.value = person.name;
                option.textContent = person.name;
                clientFilterSelect.appendChild(option);
              }
            });
          }
          peopleMap = newPeople;
        }, (err) => console.error("people onSnapshot error:", err));
      } catch (e) { console.error("listenForPeople error:", e); }
    }

    // ---------- Filters ----------
    document.getElementById('search-input')?.addEventListener('input', applyFiltersAndRender);
    document.getElementById('filter-start-date')?.addEventListener('change', applyFiltersAndRender);
    document.getElementById('filter-end-date')?.addEventListener('change', applyFiltersAndRender);
    document.getElementById('client-filter-select')?.addEventListener('change', applyFiltersAndRender);
    document.getElementById('export-csv-btn')?.addEventListener('click', exportToCSV);

    function applyFiltersAndRender() {
      let filtered = [...allTransactions];
      const searchTerm = document.getElementById('search-input')?.value?.toLowerCase() || '';
      if (searchTerm) {
        filtered = filtered.filter(tx =>
          (tx.description && tx.description.toLowerCase().includes(searchTerm)) ||
          (tx.person && tx.person.toLowerCase().includes(searchTerm))
        );
      }

      if (currentMode === 'business') {
        const selectedClient = document.getElementById('client-filter-select')?.value;
        if (selectedClient) filtered = filtered.filter(tx => tx.person === selectedClient);
      }

      const startDateValue = document.getElementById('filter-start-date')?.value;
      const endDateValue = document.getElementById('filter-end-date')?.value;

      if (startDateValue) {
        const s = new Date(startDateValue); s.setHours(0,0,0,0);
        filtered = filtered.filter(tx => tx.createdAt && tx.createdAt.toDate() >= s);
      }
      if (endDateValue) {
        const e = new Date(endDateValue); e.setHours(23,59,59,999);
        filtered = filtered.filter(tx => tx.createdAt && tx.createdAt.toDate() <= e);
      }

      filtered.sort((a,b) => (b.createdAt?.toMillis?.() || 0) - (a.createdAt?.toMillis?.() || 0));
      updateUI(filtered);
    }

    // ---------- UI rendering ----------
    function updateUI(transactions) {
      const formatter = new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR' });
      const now = new Date();
      const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
      const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

      if (currentMode === 'business') {
        renderBusinessUI(transactions, formatter, startOfMonth);
      } else {
        renderPersonalUI(transactions, formatter, startOfDay, startOfMonth);
      }
    }

    function renderPersonalUI(transactions, formatter, startOfDay, startOfMonth) {
      const transactionList = document.getElementById('transaction-list');
      if (transactionList) transactionList.innerHTML = '';
      let dailyTotal = 0, monthlyTotal = 0, receivableTotal = 0;
      const expenseCategories = {};

      if (!transactions || transactions.length === 0) {
        if (transactionList) transactionList.innerHTML = `<p class="text-gray-400 text-center py-4">No transactions found.</p>`;
      } else {
        transactions.forEach(tx => {
          if (!tx.createdAt) return;
          const txType = tx.type || 'expense';
          if (txType === 'expense' && tx.createdAt.toMillis() >= startOfMonth) {
            monthlyTotal += tx.amount;
            if (tx.createdAt.toMillis() >= startOfDay) dailyTotal += tx.amount;
            const category = (tx.description || '').split(' ')[0] || 'Other';
            expenseCategories[category] = (expenseCategories[category] || 0) + tx.amount;
          } else if (txType === 'receivable') {
            receivableTotal += tx.amount;
          }
          transactionList?.appendChild(createTransactionElement(tx, 'personal'));
        });
      }

      const dailyTotalEl = document.getElementById('daily-total');
      const monthlyTotalEl = document.getElementById('monthly-total');
      const receivableTotalEl = document.getElementById('receivable-total');
      if (dailyTotalEl) dailyTotalEl.textContent = formatter.format(dailyTotal);
      if (monthlyTotalEl) monthlyTotalEl.textContent = formatter.format(monthlyTotal);
      if (receivableTotalEl) receivableTotalEl.textContent = formatter.format(receivableTotal);
      updateBudgetUI(monthlyTotal, formatter);
      updateSpendingChart(expenseCategories);
    }

    function renderBusinessUI(transactions, formatter, startOfMonth) {
      const upcomingList = document.getElementById('upcoming-list');
      const collectedList = document.getElementById('collected-list');
      if (upcomingList) upcomingList.innerHTML = '';
      if (collectedList) collectedList.innerHTML = '';

      let pendingCollection = 0, monthlyEarnings = 0;
      const clientEarnings = {};

      const upcoming = transactions.filter(tx => tx.status === 'upcoming');
      const collected = transactions.filter(tx => tx.status === 'collected');

      upcoming.forEach(tx => {
        pendingCollection += tx.amount;
        upcomingList?.appendChild(createTransactionElement(tx, 'business-upcoming'));
      });

      collected.forEach(tx => {
        if (tx.collectedAt && tx.collectedAt.toMillis() >= startOfMonth) {
          monthlyEarnings += tx.amount;
          clientEarnings[tx.person] = (clientEarnings[tx.person] || 0) + tx.amount;
        }
        collectedList?.appendChild(createTransactionElement(tx, 'business-collected'));
      });

      if (upcoming.length === 0) upcomingList && (upcomingList.innerHTML = `<p class="text-gray-400 text-center py-4">No upcoming payments.</p>`);
      if (collected.length === 0) collectedList && (collectedList.innerHTML = `<p class="text-gray-400 text-center py-4">No collected payments yet.</p>`);

      const monthlyTotalEl = document.getElementById('monthly-total');
      const receivableTotalEl = document.getElementById('receivable-total');
      if (monthlyTotalEl) monthlyTotalEl.textContent = formatter.format(monthlyEarnings);
      if (receivableTotalEl) receivableTotalEl.textContent = formatter.format(pendingCollection);
      updateEarningsChart(clientEarnings);
    }

    function createTransactionElement(tx, type) {
      const item = document.createElement('div');
      const txDate = tx.createdAt ? tx.createdAt.toDate() : new Date();
      const initials = getInitials(tx.person || tx.description || '');
      const placeholderUrl = `https://placehold.co/40x40/4A5568/E2E8F0?text=${initials || '??'}`;
      const personPhotoURL = (tx.person && peopleMap[tx.person]) ? peopleMap[tx.person] : placeholderUrl;
      const isExpense = tx.type === 'expense';
      let borderColor = isExpense ? 'border-red-500' : 'border-green-500';
      if (type === 'business-upcoming') borderColor = 'border-yellow-500';

      item.className = `transaction-item flex items-center bg-gray-700 p-3 rounded-xl border-l-4 ${borderColor} transition duration-300`;

      let actionButtonsHTML = `<button data-id="${tx.id}" class="delete-btn ml-4 text-gray-500 hover:text-red-500" title="Delete">✖</button>`;

      if (type === 'business-upcoming') {
        actionButtonsHTML = `<button data-person="${tx.person}" data-amount="${tx.amount}" class="draft-reminder-btn ml-2 text-blue-400 hover:text-blue-300" title="Draft Reminder">✨</button>
                             <button data-id="${tx.id}" class="collect-btn ml-2 text-green-400 hover:text-green-300" title="Mark as collected">✔</button>
                             <button data-id="${tx.id}" class="delete-btn ml-2 text-gray-500 hover:text-red-500" title="Delete">✖</button>`;
      } else if (type === 'business-collected') {
        actionButtonsHTML = `<button data-id="${tx.id}" class="revert-btn ml-4 text-yellow-400 hover:text-yellow-300" title="Move to upcoming">⤴</button>`;
      }

      const personLabelText = currentMode === 'business' ? 'From:' : 'To/From:';
      const dateString = tx.status === 'collected' && tx.collectedAt ? `Collected: ${tx.collectedAt.toDate().toLocaleDateString('en-IN')}` : txDate.toLocaleString('en-IN', { day: 'numeric', month: 'short' });

      item.innerHTML = `<div class="mr-3"><img src="${personPhotoURL}" class="w-10 h-10 rounded-full object-cover"></div>
                        <div class="flex-grow">
                          <p class="font-semibold text-gray-100">${tx.description}</p>
                          ${tx.person ? `<p class="text-xs text-gray-400">${personLabelText} ${tx.person}</p>` : ''}
                          <p class="text-xs text-gray-500">${dateString}</p>
                        </div>
                        <div class="text-right"><p class="font-bold text-lg ${isExpense ? 'text-red-500' : 'text-green-500'}">${isExpense ? '-' : '+'}₹${Number(tx.amount).toFixed(2)}</p></div>
                        <div class="flex items-center">${actionButtonsHTML}</div>`;

      return item;
    }

    // dynamic list handlers
    document.getElementById('personal-view')?.addEventListener('click', e => {
      const del = e.target.closest('.delete-btn');
      if (del) deleteTransaction(del.dataset.id);
    });

    document.getElementById('business-view')?.addEventListener('click', e => {
      const collectBtn = e.target.closest('.collect-btn');
      const revertBtn = e.target.closest('.revert-btn');
      const deleteBtn = e.target.closest('.delete-btn');
      const draftBtn = e.target.closest('.draft-reminder-btn');
      if (collectBtn) updateBusinessTransactionStatus(collectBtn.dataset.id, 'collected');
      if (revertBtn) updateBusinessTransactionStatus(revertBtn.dataset.id, 'upcoming');
      if (deleteBtn) deleteTransaction(deleteBtn.dataset.id);
      if (draftBtn) handleDraftReminder(draftBtn.dataset.person, draftBtn.dataset.amount);
    });

    async function deleteTransaction(docId) {
      try {
        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/${currentMode}_transactions`, docId));
      } catch (e) { console.error("deleteTransaction error:", e); }
    }

    async function updateBusinessTransactionStatus(docId, status) {
      try {
        const updateData = { status };
        if (status === 'collected') updateData.collectedAt = serverTimestamp();
        else updateData.collectedAt = deleteField();
        await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/business_transactions`, docId), updateData);
      } catch (e) { console.error("updateBusinessTransactionStatus error:", e); }
    }

    // ---------- Budget ----------
    let monthlyBudget = 0;
    function listenForSettings() {
      try {
        const settingsDocRef = doc(db, `artifacts/${appId}/users/${userId}/settings`, 'budget');
        unsubscribeSettings = onSnapshot(settingsDocRef, (snap) => {
          if (snap.exists()) {
            monthlyBudget = snap.data().amount || 0;
            const budgetAmountInput = document.getElementById('budget-amount');
            if (budgetAmountInput) budgetAmountInput.value = monthlyBudget;
          } else {
            monthlyBudget = 0;
          }
          applyFiltersAndRender();
        }, (err) => console.error("settings onSnapshot error:", err));
      } catch (e) { console.error("listenForSettings error:", e); }
    }

    function updateBudgetUI(currentSpending, formatter) {
      const budgetProgress = document.getElementById('budget-progress');
      const budgetSummary = document.getElementById('budget-summary');
      const progress = monthlyBudget > 0 ? (currentSpending / monthlyBudget) * 100 : 0;
      if (budgetProgress) {
        budgetProgress.style.width = `${Math.min(progress, 100)}%`;
        budgetProgress.classList.toggle('bg-green-500', progress < 75);
        budgetProgress.classList.toggle('bg-yellow-500', progress >= 75 && progress < 90);
        budgetProgress.classList.toggle('bg-red-500', progress >= 90);
      }
      if (budgetSummary) budgetSummary.textContent = `${formatter.format(currentSpending)} / ${formatter.format(monthlyBudget)}`;
    }

    // ---------- Charts (fixed) ----------
    function updateSpendingChart(data) {
      // data: { label: value, ... }
      const labels = Object.keys(data);
      const values = Object.values(data).map(v => Number(v) || 0);

      // If there is no real data, provide a safe placeholder to avoid Chart.js error.
      let usePlaceholder = labels.length === 0 || values.reduce((s, v) => s + v, 0) === 0;
      const finalLabels = usePlaceholder ? ['No data'] : labels;
      const finalValues = usePlaceholder ? [1] : values;

      // prepare background colors: Chart.js accepts array or function; choose a short palette and repeat as needed.
      const baseColors = ['#FBBF24', '#F87171', '#60A5FA', '#34D399', '#A78BFA', '#F472B6', '#FDBA74'];
      const backgroundColor = finalValues.map((_, i) => baseColors[i % baseColors.length]);

      try {
        // destroy previous chart if exists
        if (spendingChart) { try { spendingChart.destroy(); } catch(e) { /* ignore */ } spendingChart = null; }

        const canvas = document.getElementById('spending-chart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');

        spendingChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: finalLabels,
            datasets: [{
              label: 'Spending',
              data: finalValues,
              backgroundColor,
              hoverOffset: 8,
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
                labels: { color: '#d1d5db' }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    // show currency formatting for pie slices
                    const val = context.raw || 0;
                    return `${context.label}: ₹${Number(val).toLocaleString('en-IN', { maximumFractionDigits: 2 })}`;
                  }
                }
              }
            }
          }
        });
      } catch (err) {
        console.error("updateSpendingChart error:", err);
      }
    }

    function updateEarningsChart(data) {
      const labels = Object.keys(data);
      const values = Object.values(data).map(v => Number(v) || 0);

      // placeholder when empty
      const usePlaceholder = labels.length === 0 || values.reduce((s,v) => s+v,0) === 0;
      const finalLabels = usePlaceholder ? ['No data'] : labels;
      const finalValues = usePlaceholder ? [1] : values;

      try {
        if (earningsChart) { try { earningsChart.destroy(); } catch(e) {} earningsChart = null; }
        const canvas = document.getElementById('earnings-chart');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');

        earningsChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: finalLabels,
            datasets: [{
              label: 'Monthly Earnings',
              data: finalValues,
              backgroundColor: '#FBBF24'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
            },
            scales: {
              x: { ticks: { color: '#9ca3af' } },
              y: { ticks: { color: '#9ca3af' } }
            }
          }
        });
      } catch (err) {
        console.error("updateEarningsChart error:", err);
      }
    }

    // ---------- Recurring ----------
    function listenForRecurring() {
      try {
        const colRef = collection(db, `artifacts/${appId}/users/${userId}/recurring_transactions`);
        unsubscribeRecurring = onSnapshot(query(colRef), (snapshot) => {
          const recurringListModal = document.getElementById('recurring-list-modal');
          if (recurringListModal) recurringListModal.innerHTML = '';
          if (snapshot.empty) {
            if (recurringListModal) recurringListModal.innerHTML = `<p class="text-center text-gray-400">No recurring transactions set.</p>`;
          } else {
            snapshot.forEach(docSnap => {
              const tx = { id: docSnap.id, ...docSnap.data() };
              if (tx.mode === 'personal') {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between p-2 bg-gray-700 rounded-xl';
                item.innerHTML = `<div><p>${tx.description} - ₹${tx.amount} (personal)</p><p class="text-xs text-gray-400">Next on: ${tx.nextDueDate?.toDate?.()?.toLocaleDateString?.() || 'N/A'}</p></div><button data-id="${tx.id}" class="delete-recurring-btn text-red-500">Delete</button>`;
                recurringListModal?.appendChild(item);
              }
            });
          }
        }, (err) => console.error("recurring onSnapshot error:", err));
      } catch (e) { console.error("listenForRecurring error:", e); }
    }

    async function checkAndProcessRecurringTransactions() {
      if (!userId) return;
      try {
        const colRef = collection(db, `artifacts/${appId}/users/${userId}/recurring_transactions`);
        const snap = await getDocs(colRef);
        snap.forEach(async docSnap => {
          const recurringTx = { id: docSnap.id, ...docSnap.data() };
          const nextDueDate = recurringTx.nextDueDate?.toDate?.();
          if (!nextDueDate) return;
          const now = new Date();
          if (nextDueDate <= now && recurringTx.mode === 'personal') {
            const { description, amount, person, type, frequency } = recurringTx;
            const newTx = { description, amount, person, type, createdAt: serverTimestamp() };
            await addDoc(collection(db, `artifacts/${appId}/users/${userId}/personal_transactions`), newTx);

            let newNextDate = new Date(nextDueDate);
            if (frequency === 'daily') newNextDate.setDate(newNextDate.getDate() + 1);
            if (frequency === 'weekly') newNextDate.setDate(newNextDate.getDate() + 7);
            if (frequency === 'monthly') newNextDate.setMonth(newNextDate.getMonth() + 1);

            await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/recurring_transactions`, recurringTx.id), { nextDueDate: newNextDate });
          }
        });
      } catch (e) { console.error("checkAndProcessRecurringTransactions error:", e); }
    }

    // ---------- CSV Export ----------
    function exportToCSV() {
      const startDateValue = document.getElementById('filter-start-date')?.value;
      const endDateValue = document.getElementById('filter-end-date')?.value;
      const selectedClient = document.getElementById('client-filter-select')?.value;

      let transactionsToExport = [...allTransactions];

      if (currentMode === 'business' && selectedClient) transactionsToExport = transactionsToExport.filter(tx => tx.person === selectedClient);

      if (startDateValue) {
        const s = new Date(startDateValue); s.setHours(0,0,0,0);
        transactionsToExport = transactionsToExport.filter(tx => tx.createdAt && tx.createdAt.toDate() >= s);
      }
      if (endDateValue) {
        const e = new Date(endDateValue); e.setHours(23,59,59,999);
        transactionsToExport = transactionsToExport.filter(tx => tx.createdAt && tx.createdAt.toDate() <= e);
      }

      const isBusiness = currentMode === 'business';
      const headers = isBusiness ? "Date,Description,Person,Amount,Type,Status" : "Date,Description,Person,Amount,Type";

      const rows = transactionsToExport.map(tx => {
        let date = 'N/A';
        if (tx.createdAt) {
          const d = tx.createdAt.toDate();
          date = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }
        const description = `"${(tx.description || '').replace(/"/g, '""')}"`;
        const rowData = [`"${date}"`, description, tx.person || '', tx.amount, tx.type];
        if (isBusiness) rowData.push(tx.status || 'N/A');
        return rowData.join(',');
      });

      const csvContent = "data:text/csv;charset=utf-8," + [headers, ...rows].join("\n");
      const encodedUri = encodeURI(csvContent);
      const link = document.createElement("a");
      link.setAttribute("href", encodedUri);
      let filename = `${currentMode}_transactions.csv`;
      if (startDateValue || endDateValue || (currentMode === 'business' && selectedClient)) filename = `${currentMode}_transactions_filtered.csv`;
      link.setAttribute("download", filename);
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    // ---------- Transaction form handling ----------
    document.getElementById('transaction-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const isBusiness = currentMode === 'business';
      const person = (document.getElementById('person')?.value || '').trim();
      const amount = parseFloat(document.getElementById('amount')?.value || '0');
      const description = isBusiness ? `Payment from ${person}` : (document.getElementById('description')?.value || '').trim();
      const type = isBusiness ? 'receivable' : (document.getElementById('type')?.value || 'expense');
      const isRecurring = document.getElementById('is-recurring-checkbox')?.checked;

      let isPersonMandatory = isBusiness || (currentMode === 'personal' && type === 'receivable');
      if (isPersonMandatory && !person) {
        document.getElementById('person-selector')?.classList.add('ring-2', 'ring-red-500');
        setTimeout(() => document.getElementById('person-selector')?.classList.remove('ring-2', 'ring-red-500'), 2000);
        return;
      }

      const isValid = !isNaN(amount) && amount > 0 && (isBusiness || description);
      if (!isValid) return;

      try {
        const personToSave = person || '';
        if (isRecurring && currentMode === 'personal') {
          const startDateValue = document.getElementById('start-date')?.value;
          const startDate = startDateValue ? new Date(startDateValue) : new Date();
          const newRecurringTx = {
            description, amount, person: personToSave, type,
            frequency: document.getElementById('frequency')?.value || 'monthly',
            nextDueDate: startDate,
            createdAt: serverTimestamp(),
            mode: 'personal'
          };
          await addDoc(collection(db, `artifacts/${appId}/users/${userId}/recurring_transactions`), newRecurringTx);
        } else {
          const newTx = { description, amount, person: personToSave, type, createdAt: serverTimestamp() };
          if (isBusiness) newTx.status = 'upcoming';
          await addDoc(collection(db, `artifacts/${appId}/users/${userId}/${currentMode}_transactions`), newTx);
        }
        resetForm();
      } catch (err) {
        console.error("adding transaction error:", err);
      }
    });

    // ---------- Recurring delete ----------
    document.getElementById('recurring-list-modal')?.addEventListener('click', async (e) => {
      const deleteBtn = e.target.closest('.delete-recurring-btn');
      if (!deleteBtn) return;
      const docIdToDelete = deleteBtn.dataset.id;
      showConfirmationModal('Are you sure you want to delete this recurring transaction?', async () => {
        await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/recurring_transactions`, docIdToDelete));
      });
    });

    // ---------- Confirmation modal ----------
    function showConfirmationModal(message, onConfirm) {
      const confirmModal = document.getElementById('confirm-modal');
      const confirmBody = document.getElementById('confirm-modal-body');
      const confirmBtn = document.getElementById('confirm-modal-confirm-btn');
      const cancelBtn = document.getElementById('confirm-modal-cancel-btn');
      if (!confirmModal || !confirmBody || !confirmBtn || !cancelBtn) return;
      confirmBody.textContent = message;
      confirmModal.classList.remove('hidden');

      const handler = async () => {
        try { await onConfirm(); } catch (e) { console.error("confirmation handler error:", e); }
        confirmModal.classList.add('hidden');
        confirmBtn.removeEventListener('click', handler);
      };

      confirmBtn.addEventListener('click', handler, { once: true });
      cancelBtn.addEventListener('click', () => confirmModal.classList.add('hidden'), { once: true });
    }

    // ---------- Reset form ----------
    function resetForm() {
      const form = document.getElementById('transaction-form');
      if (form) form.reset();
      const selectedPersonNameEl = document.getElementById('selected-person-name');
      const selectedPersonAvatar = document.getElementById('selected-person-avatar');
      const selectedPersonAvatarPlaceholder = document.getElementById('selected-person-avatar-placeholder');
      if (selectedPersonNameEl) selectedPersonNameEl.textContent = 'Select a person';
      if (selectedPersonAvatar) selectedPersonAvatar.classList.add('hidden');
      if (selectedPersonAvatarPlaceholder) selectedPersonAvatarPlaceholder.classList.remove('hidden');
    }

    // ---------- Spotlight effect ----------
    function initSpotlightEffect() {
      if (!document.querySelector('.glow-card')) return;
      let spotlight = document.querySelector('.spotlight');
      if (!spotlight) {
        spotlight = document.createElement('div');
        spotlight.className = 'spotlight';
        document.body.appendChild(spotlight);
      }
      const proximity = 120, fadeDistance = 260;
      const handleMouseMove = (e) => {
        let minDistance = Infinity;
        document.querySelectorAll('.glow-card').forEach(card => {
          const rect = card.getBoundingClientRect();
          const cx = rect.left + rect.width/2;
          const cy = rect.top + rect.height/2;
          const distance = Math.hypot(e.clientX - cx, e.clientY - cy) - Math.max(rect.width, rect.height)/2;
          const effective = Math.max(0, distance);
          minDistance = Math.min(minDistance, effective);
          const relX = ((e.clientX - rect.left) / rect.width) * 100;
          const relY = ((e.clientY - rect.top) / rect.height) * 100;
          let glowIntensity = 0;
          if (effective <= proximity) glowIntensity = 1;
          else if (effective <= fadeDistance) glowIntensity = (fadeDistance - effective)/(fadeDistance - proximity);
          card.style.setProperty('--glow-x', `${relX}%`);
          card.style.setProperty('--glow-y', `${relY}%`);
          card.style.setProperty('--glow-intensity', glowIntensity.toString());
        });
        gsap.to(spotlight, { left: e.clientX, top: e.clientY, duration: 0.12, ease: 'power2.out' });
        const targetOpacity = minDistance <= proximity ? 0.8 : minDistance <= fadeDistance ? ((fadeDistance - minDistance)/(fadeDistance - proximity)) * 0.8 : 0;
        gsap.to(spotlight, { opacity: targetOpacity, duration: targetOpacity>0?0.2:0.45, ease: 'power2.out' });
      };
      const handleMouseLeave = () => {
        gsap.to(spotlight, { opacity: 0, duration: 0.3, ease: 'power2.out' });
        document.querySelectorAll('.glow-card').forEach(card => card.style.setProperty('--glow-intensity', '0'));
      };
      document.addEventListener('mousemove', handleMouseMove);
      document.addEventListener('mouseleave', handleMouseLeave);
    }

    // ---------- Small utilities ----------
    function handleDraftReminder(person, amount) {
      alert(`Reminder to ${person} for ₹${amount}`);
    }

    // Optional: people modal selection
    document.getElementById('people-list-modal')?.addEventListener('click', (e) => {
      const personDiv = e.target.closest('.person-select-trigger');
      if (!personDiv) return;
      const name = personDiv.dataset.name;
      const photo = personDiv.dataset.photo;
      document.getElementById('person').value = name;
      document.getElementById('selected-person-name').textContent = name;
      const img = document.getElementById('selected-person-avatar');
      const placeholder = document.getElementById('selected-person-avatar-placeholder');
      if (img) { img.src = photo; img.classList.remove('hidden'); }
      if (placeholder) placeholder.classList.add('hidden');
      document.getElementById('people-modal')?.classList.add('hidden');
    });

    // ---------- Init listeners for UI controls ----------
    document.getElementById('person-selector')?.addEventListener('click', () => document.getElementById('people-modal')?.classList.remove('hidden'));
    document.getElementById('close-people-modal-btn')?.addEventListener('click', () => document.getElementById('people-modal')?.classList.add('hidden'));
    document.getElementById('manage-recurring-btn')?.addEventListener('click', () => document.getElementById('recurring-modal')?.classList.remove('hidden'));
    document.getElementById('close-recurring-modal-btn')?.addEventListener('click', () => document.getElementById('recurring-modal')?.classList.add('hidden'));
    document.getElementById('set-budget-btn')?.addEventListener('click', () => document.getElementById('budget-modal')?.classList.remove('hidden'));
    document.getElementById('cancel-budget-btn')?.addEventListener('click', () => document.getElementById('budget-modal')?.classList.add('hidden'));

    // Add person form
    document.getElementById('add-person-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const newName = (document.getElementById('new-person-name')?.value || '').trim();
      if (!newName) return;
      try {
        const initials = getInitials(newName);
        const photoURL = `https://placehold.co/64x64/4A5568/E2E8F0?text=${initials}`;
        await addDoc(collection(db, `artifacts/${appId}/users/${userId}/${currentMode}_people`), { name: newName, photoURL });
        (document.getElementById('add-person-form'))?.reset();
      } catch (err) { console.error("add person error:", err); }
    });

    // Budget form
    document.getElementById('budget-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      const newBudget = parseFloat(document.getElementById('budget-amount')?.value || '0');
      if (isNaN(newBudget) || newBudget < 0) return;
      try {
        await setDoc(doc(db, `artifacts/${appId}/users/${userId}/settings`, 'budget'), { amount: newBudget });
        document.getElementById('budget-modal')?.classList.add('hidden');
      } catch (err) { console.error("set budget error:", err); }
    });

    // Recurring: toggle fields
    document.getElementById('is-recurring-checkbox')?.addEventListener('change', (e) => {
      document.getElementById('recurring-fields-wrapper')?.classList.toggle('hidden', !e.target.checked);
    });

    // ---------- Final small init ----------
    // Hide global loader if still visible
    if (globalLoader) setTimeout(() => globalLoader.classList.add('hidden'), 800);

    // End of module script
  </script>
</body>
</html>
