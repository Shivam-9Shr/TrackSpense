<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Transaction Tracker — Debug Build</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .loader { border: 2px solid rgba(255,255,255,0.25); border-top-color: #FBBF24; border-radius:50%; width:2.2rem; height:2.2rem; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .notice { background: #111827; border: 1px solid #374151; color: #e5e7eb; padding: 10px; border-radius: 8px; }
  </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen flex items-center justify-center p-4">

  <!-- Global loader -->
  <div id="global-loader" class="fixed inset-0 bg-gray-900/95 flex flex-col items-center justify-center z-50">
    <div class="loader mb-4" id="global-loader-spinner"></div>
    <p id="global-loader-text" class="text-gray-400">Loading application...</p>
    <div id="debug-hint" class="mt-4 text-sm text-gray-500 max-w-xl text-center"></div>
  </div>

  <!-- Auth view -->
  <div id="auth-view" class="hidden w-full max-w-md mx-auto">
    <div class="notice">
      <h2 class="text-xl font-semibold mb-2">Sign in</h2>
      <p class="text-sm text-gray-300 mb-4">Sign in with Google to continue.</p>
      <button id="google-signin-btn" class="w-full bg-gray-800 text-white py-2 rounded-md">Sign in with Google</button>
      <p id="auth-error" class="text-sm text-red-400 mt-3"></p>
      <p id="auth-debug" class="text-xs text-gray-400 mt-2"></p>
    </div>
  </div>

  <!-- Minimal app view (shown after login) -->
  <div id="app-view" class="hidden w-full max-w-3xl mx-auto">
    <div class="notice">
      <h1 class="text-2xl font-bold mb-2">Transaction Tracker (app)</h1>
      <p class="text-sm text-gray-300">App loaded — you are authenticated.</p>
      <button id="sign-out-btn" class="mt-4 bg-red-600 text-white py-1 px-3 rounded">Sign out</button>
    </div>
  </div>

<script type="module">
/* ========= Defensive, debug-enabled Firebase auth + fail-safe =========
   - If onAuthStateChanged isn't called within 8s, we show the login screen
     and display helpful debug hints.
   - Captures and prints probable causes: invalid config, unauthorized domain,
     blocked cookies, network issues.
   - This file preserves your Firebase config and main app wiring (but simplified UI here).
*/

import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import {
  getAuth,
  onAuthStateChanged,
  GoogleAuthProvider,
  signInWithRedirect,
  getRedirectResult,
  signOut,
  setPersistence,
  browserLocalPersistence,
  signInWithPopup
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

import {
  getFirestore
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// === Firebase config (from your earlier file) ===
const firebaseConfig = {
  apiKey: "AIzaSyBQE9DZBL3ugPDWBVKj8piCVT7q-X9p0to",
  authDomain: "expense-manager-2158b.firebaseapp.com",
  projectId: "expense-manager-2158b",
  storageBucket: "expense-manager-2158b.firebasestorage.app",
  messagingSenderId: "596327333035",
  appId: "1:596327333035:web:e2ec1998729a81e7258bee",
  measurementId: "G-QXTERJV3V8"
};

// === DOM refs ===
const globalLoader = document.getElementById('global-loader');
const globalLoaderText = document.getElementById('global-loader-text');
const debugHint = document.getElementById('debug-hint');
const authView = document.getElementById('auth-view');
const appView = document.getElementById('app-view');
const googleSigninBtn = document.getElementById('google-signin-btn');
const authErrorEl = document.getElementById('auth-error');
const authDebugEl = document.getElementById('auth-debug');
const signOutBtn = document.getElementById('sign-out-btn');

let auth, db;
let authStateKnown = false;
let authStateTimeoutHandle = null;

// Utility: update UI / console with debugging hints
function setDebug(text) {
  console.log("[APP DEBUG]", text);
  if (debugHint) debugHint.textContent = text;
}
function setAuthError(text) {
  console.warn("[AUTH ERROR]", text);
  if (authErrorEl) authErrorEl.textContent = text;
  if (authDebugEl) authDebugEl.textContent = "Open DevTools → Console for detailed logs.";
}

// Try to initialize Firebase safely
try {
  const app = initializeApp(firebaseConfig);
  db = getFirestore(app);
  auth = getAuth(app);
  setDebug("Firebase initialized.");
} catch (e) {
  // If initialization fails, reveal auth view so user can see the error
  console.error("Firebase initialization error:", e);
  setAuthError("Firebase initialization failed — check firebaseConfig in your app.");
  globalLoader.classList.add('hidden');
  authView.classList.remove('hidden');
  setDebug("Firebase init failed — shown auth screen to user.");
  // Stop further execution
  throw e;
}

// set persistence to local (so redirect-based sign in survives reloads)
setPersistence(auth, browserLocalPersistence).catch(err => {
  console.warn("setPersistence warning:", err);
  // Not fatal — continue
});

// Helper: determine if domain is authorized (best-effort)
function likelyUnauthorizedDomainError(err) {
  // Firebase throws error codes like "auth/unauthorized-domain"
  return (err && err.code && err.code.includes && err.code.includes('unauthorized-domain'));
}

// Attach a safety timeout: if onAuthStateChanged hasn't fired in X seconds, show login
const AUTH_STATE_TIMEOUT_MS = 8000;
authStateTimeoutHandle = setTimeout(() => {
  if (!authStateKnown) {
    // show auth view and helpful hints
    const hintParts = [];
    hintParts.push("Auth state not received after 8s — possible causes:");
    hintParts.push("• Your app domain is not added to Firebase Authentication → Authorized domains.");
    hintParts.push("• Third-party cookies blocked (redirect sign-in may fail).");
    hintParts.push("• Network / CORS issue or Firebase blocked by browser extension.");
    setDebug(hintParts.join(" "));
    setAuthError("Sign-in not completed. Check console for details and authorized domains in Firebase.");
    // show auth view
    globalLoader.classList.add('hidden');
    authView.classList.remove('hidden');
  }
}, AUTH_STATE_TIMEOUT_MS);

// log a couple of environment facts
setDebug(`Running on ${location.origin} — firebase authDomain is ${firebaseConfig.authDomain}`);

// Observe auth state
onAuthStateChanged(auth, async (user) => {
  authStateKnown = true;
  if (authStateTimeoutHandle) { clearTimeout(authStateTimeoutHandle); authStateTimeoutHandle = null; }
  setDebug("onAuthStateChanged fired. user=" + (user ? user.uid : "null"));

  // hide loader and switch view accordingly
  globalLoader.classList.add('hidden');

  if (user) {
    // User is signed in
    authView.classList.add('hidden');
    appView.classList.remove('hidden');
    setDebug(`User signed in: ${user.uid} (${user.email || 'no-email'})`);
  } else {
    // Not signed in
    authView.classList.remove('hidden');
    appView.classList.add('hidden');
    setDebug("No user signed in — showing sign-in screen.");
  }
});

// Also process redirect result to find redirect errors earlier
getRedirectResult(auth).then((result) => {
  if (result && result.user) {
    console.log("Redirect sign-in result received (user).");
  } else {
    console.log("getRedirectResult: no redirect result (this is normal if no redirect happened).");
  }
}).catch(err => {
  console.error("getRedirectResult error:", err);
  if (likelyUnauthorizedDomainError(err)) {
    setAuthError("Unauthorized domain — add your app domain to Firebase Console → Authentication → Authorized domains.");
  } else {
    setAuthError("Redirect processing error: " + (err.code || err.message || err));
  }
  // Ensure loader doesn't stay forever
  globalLoader.classList.add('hidden');
  authView.classList.remove('hidden');
});

// Sign-in button (redirect, fallback to popup)
googleSigninBtn.addEventListener('click', async () => {
  if (!auth) {
    setAuthError("Auth not initialized.");
    return;
  }
  authErrorEl.textContent = '';
  try {
    const provider = new GoogleAuthProvider();
    setDebug("Starting sign-in with redirect...");
    await signInWithRedirect(auth, provider);
  } catch (err) {
    console.warn("signInWithRedirect failed, trying popup fallback:", err);
    // If unauthorized-domain, show helpful message
    if (likelyUnauthorizedDomainError(err)) {
      setAuthError("Unauthorized domain. Add your app domain in Firebase Console → Authentication → Authorized domains.");
    } else {
      try {
        setDebug("Attempting signInWithPopup fallback...");
        await signInWithPopup(auth, new GoogleAuthProvider());
      } catch (popupErr) {
        console.error("Popup sign-in failed:", popupErr);
        setAuthError("Sign-in failed (popup). Check console. " + (popupErr.code || popupErr.message || ""));
      }
    }
  }
});

// Sign out button (visible in app-view)
signOutBtn.addEventListener('click', async () => {
  try {
    await signOut(auth);
    setDebug("User signed out.");
    authView.classList.remove('hidden');
    appView.classList.add('hidden');
  } catch (err) {
    console.error("signOut error:", err);
    setAuthError("Sign-out failed: " + (err.code || err.message));
  }
});

/* Extra diagnostic: show a small test that indicates if third-party cookies might be blocked.
   Note: modern browsers don't expose a direct API to detect cookie blocking reliably; this
   is a gentle heuristic — we try an auth redirect lifecycle and show a hint in console.
*/
async function quickCookieCheck() {
  // Try to open an iframe to accounts.google.com could be blocked by browser; we'll only provide hints.
  setDebug("If sign-in still fails: check that third-party cookies are not blocked (Chrome → Settings → Cookies)");
}
quickCookieCheck();

// If user still sees loader: check DevTools Console for logs printed with [APP DEBUG] and errors.
// End of debug-enabled auth file.
</script>
</body>
</html>
