<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Transaction Tracker — Auth Fix</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; background:#0f172a; color:#e5e7eb; min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
    .card { background:#0b1220; border:1px solid #1f2937; padding:28px; border-radius:12px; width:420px; box-shadow: 0 6px 24px rgba(2,6,23,0.6); }
    .btn { display:flex; align-items:center; gap:10px; background:#111827; color:#fff; padding:10px 14px; border-radius:12px; cursor:pointer; border:1px solid #374151; }
    .btn:active { transform: translateY(1px); }
    .loader { width:20px; height:20px; border-radius:50%; border:3px solid rgba(255,255,255,0.15); border-top-color:#f59e0b; animation:spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .hidden { display:none; }
    .small { font-size:13px; color:#9ca3af; }
    .error { color:#fb7185; font-weight:600; }
    .hint { font-size:13px; color:#9ca3af; margin-top:8px; }
    .logo { width:20px; height:20px; }
    pre { background:#071022; padding:8px; border-radius:8px; overflow:auto; max-height:160px; color:#cbd5e1; font-size:13px; }
  </style>
</head>
<body>
  <div class="card" id="card">
    <h2 style="font-size:20px;margin-bottom:8px">Transaction Tracker — Sign in</h2>
    <p class="small" id="sub">Sign in with Google to continue. (This build tries **popup** first, then **redirect**.)</p>

    <div style="margin-top:18px;">
      <button id="google-btn" class="btn" aria-label="Sign in with Google">
        <img class="logo" src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'><path fill='%23FFC107' d='M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 12.955 4 4 12.955 4 24s8.955 20 20 20 20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z'/><path fill='%23FF3D00' d='m6.306 14.691 6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4 16.318 4 9.656 8.337 6.306 14.691z'/><path fill='%234CAF50' d='m24 44c5.166 0 9.86-1.977 13.409-5.192l-6.19-5.238A11.91 11.91 0 0 1 24 36c-5.222 0-9.618-3.234-11.303-7.618l-6.571 4.819A20 20 0 0 0 24 44z'/><path fill='%231976D2' d='M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C44.434 36.316 48 30.732 48 24c0-1.341-.138-2.65-.389-3.917z'/></svg>" />
        <span id="google-text">Sign in with Google</span>
        <div id="btn-loader" class="loader hidden" aria-hidden="true"></div>
      </button>
    </div>

    <p class="hint" id="hint">If the button doesn't open a popup, you may need to allow popups or add this domain to Firebase → Authentication → Authorized domains.</p>

    <div id="status" style="margin-top:14px;">
      <p id="status-line" class="small"></p>
      <p id="error-line" class="error" style="margin-top:6px"></p>
    </div>

    <details style="margin-top:10px;color:#9ca3af">
      <summary style="cursor:pointer">Developer console logs</summary>
      <pre id="console-log">No logs yet.</pre>
    </details>

    <div style="margin-top:10px" id="manual-instructions" class="small hidden">
      <p><strong>Manual fix steps:</strong></p>
      <ol>
        <li>Open Firebase Console → Authentication → Authorized domains → Add <code id="origin"></code></li>
        <li>Try again in an incognito window with extensions disabled.</li>
        <li>If using a hosted preview (e.g. firebase preview URL), add that exact domain too.</li>
      </ol>
    </div>
  </div>

<script type="module">
  // Popup-first Google sign-in with redirect fallback and verbose logging.
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
  import {
    getAuth,
    GoogleAuthProvider,
    signInWithPopup,
    signInWithRedirect,
    getRedirectResult,
    onAuthStateChanged,
    signOut,
    setPersistence,
    browserLocalPersistence
  } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

  // --- CONFIG: your firebaseConfig (keep as-is) ---
  const firebaseConfig = {
    apiKey: "AIzaSyBQE9DZBL3ugPDWBVKj8piCVT7q-X9p0to",
    authDomain: "expense-manager-2158b.firebaseapp.com",
    projectId: "expense-manager-2158b",
    storageBucket: "expense-manager-2158b.firebasestorage.app",
    messagingSenderId: "596327333035",
    appId: "1:596327333035:web:e2ec1998729a81e7258bee",
    measurementId: "G-QXTERJV3V8"
  };

  // --- UI refs ---
  const googleBtn = document.getElementById('google-btn');
  const googleText = document.getElementById('google-text');
  const btnLoader = document.getElementById('btn-loader');
  const statusLine = document.getElementById('status-line');
  const errorLine = document.getElementById('error-line');
  const consoleLog = document.getElementById('console-log');
  const originEl = document.getElementById('origin');
  const manualIns = document.getElementById('manual-instructions');

  function log(...args) {
    console.log('[APP]', ...args);
    consoleLog.textContent += args.map(a => typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a)).join(' ') + "\n";
    consoleLog.scrollTop = consoleLog.scrollHeight;
  }
  function setStatus(txt) { statusLine.textContent = txt; log(txt); }
  function setError(txt) { errorLine.textContent = txt; log('ERROR:', txt); }

  originEl.textContent = location.origin;

  // --- init firebase ---
  let auth;
  try {
    const app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    // try to set persistence; not fatal if it fails
    setPersistence(auth, browserLocalPersistence).catch(e => log('setPersistence warning', e));
    log('Firebase initialized. authDomain:', firebaseConfig.authDomain);
  } catch (e) {
    setError('Firebase initialization failed. Check firebaseConfig. See console.');
    log(e);
    showManual();
    throw e;
  }

  // show redirect result if any (helps debug redirect errors)
  getRedirectResult(auth).then(result => {
    if (result && result.user) {
      setStatus(`Redirect sign-in succeeded: ${result.user.email || result.user.uid}`);
    } else {
      log('No redirect result (normal if no redirect).');
    }
  }).catch(err => {
    setError('Redirect processing error: ' + (err.code || err.message || err));
    log('getRedirectResult error', err);
    showManual();
  });

  // keep UI reactive to auth state
  onAuthStateChanged(auth, (user) => {
    if (user) {
      setStatus(`Signed in as ${user.displayName || user.email || user.uid}`);
      googleText.textContent = 'Signed in — reload to test';
      btnLoader.classList.add('hidden');
      googleBtn.disabled = true;
      manualIns.classList.add('hidden');
    } else {
      setStatus('Not signed in');
      googleText.textContent = 'Sign in with Google';
      googleBtn.disabled = false;
    }
  });

  // primary sign-in action: popup-first, redirect fallback
  googleBtn.addEventListener('click', async () => {
    btnLoader.classList.remove('hidden');
    googleText.style.opacity = '0.6';
    googleBtn.disabled = true;
    setStatus('Attempting popup sign-in...');
    errorLine.textContent = '';

    const provider = new GoogleAuthProvider();

    // helper to restore UI
    function restoreUI() {
      btnLoader.classList.add('hidden');
      googleText.style.opacity = '1';
      googleBtn.disabled = false;
    }

    try {
      // Try popup first (less likely to fail if cookies allowed)
      const res = await signInWithPopup(auth, provider);
      setStatus('Popup sign-in successful: ' + (res.user.email || res.user.uid));
      log('Popup result', res);
      restoreUI();
      return;
    } catch (popupErr) {
      log('Popup sign-in failed:', popupErr);
      // If popup blocked by browser or other error, fallback to redirect
      // Common reasons: popup blocked by browser, 3rd-party cookies blocked, browser extensions
      const isPopupBlocked = popupErr && (popupErr.code === 'auth/popup-blocked' || popupErr.code === 'auth/cancelled-popup-request' || popupErr.name === 'FirebaseError');
      setError('Popup sign-in failed. Trying redirect fallback. (See console for details.)');
      setStatus('Popup failed — attempting redirect sign-in fallback...');

      // small delay so user sees message
      await new Promise(r => setTimeout(r, 600));

      try {
        await signInWithRedirect(auth, provider);
        // redirect will navigate away — no further code will run here
      } catch (redirectErr) {
        restoreUI();
        // If redirect fails, show precise instructions
        log('signInWithRedirect failed:', redirectErr);
        setError('Redirect sign-in also failed: ' + (redirectErr.code || redirectErr.message || redirectErr));
        // Show manual instruction box explaining likely causes
        showManual();
      }
    }
  });

  // convenience: sign-out by clicking the status area (for tests)
  statusLine.addEventListener('click', async () => {
    try {
      await signOut(auth);
      setStatus('Signed out');
    } catch (e) {
      log('signOut failed', e);
      setError('Sign-out failed: ' + (e.message || e));
    }
  });

  // show manual instructions area
  function showManual() {
    manualIns.classList.remove('hidden');
  }

  // Extra hints for the user
  (function runHints() {
    setTimeout(() => {
      // If the button never opened a popup and nothing logged, likely issue: popup blocking or extensions
      log('Hints: If sign-in still does not appear, try: (1) Incognito with extensions off, (2) Add ' + location.origin + ' to Firebase Authorized domains, (3) Allow popups for this site.');
    }, 300);
  })();

</script>
</body>
</html>
